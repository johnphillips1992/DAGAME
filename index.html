<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid Mechanics - Strategic Puzzle</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #0a0a0a;
            color: white;
            font-family: monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        canvas {
            border: 2px solid #333;
            background: #000;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            width: 512px;
            height: 512px;
        }
        
        #info {
            margin-top: 15px;
            text-align: center;
            font-size: 13px;
        }
        
        h1 {
            margin: 10px 0;
            color: #ffd700;
            font-size: 20px;
            letter-spacing: 3px;
        }
        
        .stats {
            margin: 8px 0;
            padding: 6px 15px;
            background: #1a1a1a;
            border: 1px solid #333;
            display: inline-block;
        }
        
        .legend {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 10px auto;
            max-width: 600px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
        }
        
        .color-box {
            width: 12px;
            height: 12px;
            border: 1px solid #333;
        }
    </style>
</head>
<body>
    <h1>GRID MECHANICS</h1>
    <canvas id="gameCanvas"></canvas>
    <div id="info">
        <div class="stats">
            <strong>Moves: <span id="moves">0</span> | Level: <span id="level">1</span>/5 | Best: <span id="best">--</span></strong>
        </div>
        <div class="legend">
            <div class="legend-item">
                <div class="color-box" style="background: #ffd700;"></div>
                <span>Player</span>
            </div>
            <div class="legend-item">
                <div class="color-box" style="background: #ff6b6b;"></div>
                <span>Push Block</span>
            </div>
            <div class="legend-item">
                <div class="color-box" style="background: #4dabf7;"></div>
                <span>Goal</span>
            </div>
            <div class="legend-item">
                <div class="color-box" style="background: #333;"></div>
                <span>Wall</span>
            </div>
            <div class="legend-item">
                <div class="color-box" style="background: #00ff00;"></div>
                <span>Spring (↑)</span>
            </div>
            <div class="legend-item">
                <div class="color-box" style="background: #ff00ff;"></div>
                <span>Teleport In</span>
            </div>
            <div class="legend-item">
                <div class="color-box" style="background: #ff88ff;"></div>
                <span>Teleport Out</span>
            </div>
            <div class="legend-item">
                <div class="color-box" style="background: #00ffff;"></div>
                <span>Ice</span>
            </div>
        </div>
        <div class="stats">
            ↑↓←→ Move | R: Restart | N: Next (when solved) | Springs launch blocks upward!
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const GRID_SIZE = 64;
        canvas.width = GRID_SIZE;
        canvas.height = GRID_SIZE;

        // Game state
        let moves = 0;
        let currentLevel = 1;
        let gameWon = false;
        let bestScores = [null, null, null, null, null];
        
        // Colors
        const COLORS = {
            EMPTY: '#000000',
            PLAYER: '#ffd700',
            WALL: '#333333',
            PUSHBLOCK: '#ff6b6b',
            GOAL: '#4dabf7',
            PUSHBLOCK_ON_GOAL: '#ff00ff',
            SPRING: '#00ff00',
            TELEPORTER_IN: '#ff00ff',
            TELEPORTER_OUT: '#ff88ff',
            ICE: '#00ffff',
            GRID: '#0a0a0a'
        };

        // Levels with full 64x64 usage
        const LEVELS = [
            // Level 1 - Introduction to springs and basic mechanics
            {
                player: {x: 32, y: 50},
                walls: createLevelWalls([
                    '################################################################',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#######################..................#######################',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................##############################################',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#######################..................#######################',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................##############################################',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '################################################################'
                ]),
                pushBlocks: [{x: 30, y: 48}, {x: 10, y: 48}, {x: 50, y: 48}],
                goals: [{x: 10, y: 5}, {x: 32, y: 5}, {x: 50, y: 5}],
                springs: [{x: 10, y: 35}, {x: 32, y: 35}, {x: 50, y: 35}],
                teleportersIn: [],
                teleportersOut: [],
                ice: []
            },
            // Level 2 - Spring chains
            {
                player: {x: 5, y: 58},
                walls: createLevelWalls([
                    '################################################################',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#############..................##..................#############',
                    '#...........#..................##..................#...........#',
                    '#...........#..................##..................#...........#',
                    '#...........#..................##..................#...........#',
                    '#...........#..................##..................#...........#',
                    '#...........#..................##..................#...........#',
                    '#...........#####################################...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#..................................#...........#',
                    '#...........#####################################...........#',
                    '#...........................................................#',
                    '#...........................................................#',
                    '#...........................................................#',
                    '#...........................................................#',
                    '#...........................................................#',
                    '#...........................................................#',
                    '#...........................................................#',
                    '#...........................................................#',
                    '#...........................................................#',
                    '#...........................................................#',
                    '#...........................................................#',
                    '#...........................................................#',
                    '#...........................................................#',
                    '#...........................................................#',
                    '#...........................................................#',
                    '################################################################'
                ]),
                pushBlocks: [{x: 8, y: 55}, {x: 25, y: 55}, {x: 40, y: 55}, {x: 55, y: 55}],
                goals: [{x: 5, y: 12}, {x: 57, y: 12}, {x: 20, y: 25}, {x: 42, y: 25}],
                springs: [
                    {x: 8, y: 50}, {x: 8, y: 40}, {x: 8, y: 30}, {x: 8, y: 20},
                    {x: 55, y: 50}, {x: 55, y: 40}, {x: 55, y: 30}, {x: 55, y: 20},
                    {x: 20, y: 45}, {x: 20, y: 35},
                    {x: 42, y: 45}, {x: 42, y: 35}
                ],
                teleportersIn: [],
                teleportersOut: [],
                ice: []
            },
            // Level 3 - Teleporter introduction
            {
                player: {x: 32, y: 58},
                walls: createLevelWalls([
                    '################################################################',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '###########....#############################....###############',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '############..###############################..################',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '#..............................##..............................#',
                    '##############..#########################..####################',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '################################################################'
                ]),
                pushBlocks: [{x: 10, y: 55}, {x: 20, y: 55}, {x: 44, y: 55}, {x: 54, y: 55}],
                goals: [{x: 10, y: 5}, {x: 20, y: 5}, {x: 44, y: 5}, {x: 54, y: 5}],
                springs: [],
                teleportersIn: [{x: 15, y: 28}, {x: 49, y: 28}],
                teleportersOut: [{x: 15, y: 18}, {x: 49, y: 18}],
                ice: []
            },
            // Level 4 - Ice mechanics with teleporters
            {
                player: {x: 32, y: 55},
                walls: createLevelWalls([
                    '################################################################',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#######################..................#######################',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#........................................#',
                    '#.....................#........................................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '################################################################',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#######################..................#######################',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#........................................#',
                    '#.....................#........................................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#..................#.....................#',
                    '#.....................#####################################....#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '#..............................................................#',
                    '################################################################'
                ]),
                pushBlocks: [{x: 30, y: 50}, {x: 34, y: 50}, {x: 10, y: 35}, {x: 54, y: 35}],
                goals: [{x: 10, y: 15}, {x: 54, y: 15}, {x: 10, y: 45}, {x: 54, y: 45}],
                springs: [{x: 32, y: 40}],
                teleportersIn: [{x: 5, y: 30}, {x: 58, y: 30}],
                teleportersOut: [{x: 5, y: 12}, {x: 58, y: 12}],
                ice: []
            },
            // Level 5 - Everything combined - complex puzzle
            {
                player: {x: 32, y: 60},
                walls: createLevelWalls([
                    '################################################################',
                    '#......#......................................................#',
                    '#......#......................................................#',
                    '#......#......................................................#',
                    '#......#......................................................#',
                    '#......#......................................................#',
                    '#......#############################################......#',
                    '#......#...........................................#......#',
                    '#......#...........................................#......#',
                    '#......#...........................................#......#',
                    '#......#...........................................#......#',
                    '#......#...........................................#......#',
                    '#......#...........................................#......#',
                    '#......#...........................................#......#',
                    '#......#...........................................#......#',
                    '#......#...........................................#......#',
                    '#......#############################################......#',
                    '#......................................................#',
                    '#......................................................#',
                    '#......................................................#',
                    '#......................................................#',
                    '#......................................................#',
                    '#......................................................#',
                    '#......................................................#',
                    '#......................................................#',
                    '#########################......#########################',
                    '#.......................#......#.......................#',
                    '#.......................#......#.......................#',
                    '#.......................#......#.......................#',
                    '#.......................#......#.......................#',
                    '#.......................#......#.......................#',
                    '#.......................#......#.......................#',
                    '#.......................#......#.......................#',
                    '#.......................#......#.......................#',
                    '#.......................#......#.......................#',
                    '#.......................#......#.......................#',
                    '#.......................#......#.......................#',
                    '#.......................#......#.......................#',
                    '#.......................########.......................#',
                    '#......................................................#',
                    '#......................................................#',
                    '#......................................................#',
                    '#......................................................#',
                    '#......................................................#',
                    '#......................................................#',
                    '#......................................................#',
                    '#......................................................#',
                    '#......................................................#',
                    '#......#############################################......#',
                    '#......#...........................................#......#',
                    '#......#...........................................#......#',
                    '#......#...........................................#......#',
                    '#......#...........................................#......#',
                    '#......#...........................................#......#',
                    '#......#...........................................#......#',
                    '#......#...........................................#......#',
                    '#......#...........................................#......#',
                    '#......#...........................................#......#',
                    '#......#############################################......#',
                    '#......................................................#',
                    '#......................................................#',
                    '#......................................................#',
                    '#......................................................#',
                    '################################################################'
                ]),
                pushBlocks: [
                    {x: 30, y: 58}, {x: 34, y: 58}, 
                    {x: 10, y: 45}, {x: 54, y: 45},
                    {x: 20, y: 30}, {x: 44, y: 30}
                ],
                goals: [
                    {x: 3, y: 3}, {x: 60, y: 3}, 
                    {x: 10, y: 11}, {x: 53, y: 11},
                    {x: 10, y: 51}, {x: 53, y: 51}
                ],
                springs: [
                    {x: 32, y: 55}, {x: 32, y: 50}, {x: 32, y: 45},
                    {x: 10, y: 40}, {x: 10, y: 35},
                    {x: 54, y: 40}, {x: 54, y: 35},
                    {x: 20, y: 20}, {x: 44, y: 20}
                ],
                teleportersIn: [
                    {x: 3, y: 20}, {x: 60, y: 20},
                    {x: 28, y: 43}, {x: 36, y: 43}
                ],
                teleportersOut: [
                    {x: 3, y: 8}, {x: 60, y: 8},
                    {x: 28, y: 11}, {x: 36, y: 11}
                ],
                ice: [
                    ...Array(10).fill(0).map((_, i) => ({x: 27 + i, y: 30})),
                    ...Array(10).fill(0).map((_, i) => ({x: 27 + i, y: 31})),
                    ...Array(10).fill(0).map((_, i) => ({x: 27 + i, y: 32})),
                    ...Array(10).fill(0).map((_, i) => ({x: 27 + i, y: 33})),
                    ...Array(10).fill(0).map((_, i) => ({x: 27 + i, y: 34}))
                ]
            }
        ];

        function createLevelWalls(asciiMap) {
            const walls = [];
            for (let y = 0; y < asciiMap.length && y < 64; y++) {
                for (let x = 0; x < asciiMap[y].length && x < 64; x++) {
                    if (asciiMap[y][x] === '#') {
                        walls.push({x, y});
                    }
                }
            }
            return walls;
        }

        let level, player, walls, pushBlocks, goals, springs, teleportersIn, teleportersOut, ice;

        function loadLevel(levelNum) {
            if (levelNum > LEVELS.length) levelNum = 1;
            currentLevel = levelNum;
            const levelData = LEVELS[levelNum - 1];
            
            player = {...levelData.player};
            walls = [...levelData.walls];
            pushBlocks = levelData.pushBlocks.map(b => ({...b}));
            goals = [...levelData.goals];
            springs = [...levelData.springs];
            teleportersIn = [...levelData.teleportersIn];
            teleportersOut = [...levelData.teleportersOut];
            ice = [...levelData.ice];
            
            moves = 0;
            gameWon = false;
            updateDisplay();
            draw();
        }

        function draw() {
            ctx.fillStyle = COLORS.EMPTY;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw ice tiles
            ctx.fillStyle = COLORS.ICE;
            ice.forEach(tile => {
                ctx.fillRect(tile.x, tile.y, 1, 1);
            });
            
            // Draw teleporter inputs
            ctx.fillStyle = COLORS.TELEPORTER_IN;
            teleportersIn.forEach(tp => {
                ctx.fillRect(tp.x, tp.y, 1, 1);
            });
            
            // Draw teleporter outputs
            ctx.fillStyle = COLORS.TELEPORTER_OUT;
            teleportersOut.forEach(tp => {
                ctx.fillRect(tp.x, tp.y, 1, 1);
            });
            
            // Draw springs
            ctx.fillStyle = COLORS.SPRING;
            springs.forEach(spring => {
                ctx.fillRect(spring.x, spring.y, 1, 1);
            });
            
            // Draw goals
            ctx.fillStyle = COLORS.GOAL;
            goals.forEach(goal => {
                ctx.fillRect(goal.x, goal.y, 1, 1);
            });
            
            // Draw walls
            ctx.fillStyle = COLORS.WALL;
            walls.forEach(wall => {
                ctx.fillRect(wall.x, wall.y, 1, 1);
            });
            
            // Draw push blocks
            pushBlocks.forEach(block => {
                const isOnGoal = goals.some(g => g.x === block.x && g.y === block.y);
                ctx.fillStyle = isOnGoal ? COLORS.PUSHBLOCK_ON_GOAL : COLORS.PUSHBLOCK;
                ctx.fillRect(block.x, block.y, 1, 1);
            });
            
            // Draw player
            ctx.fillStyle = COLORS.PLAYER;
            ctx.fillRect(player.x, player.y, 1, 1);
            
            // Win overlay
            if (gameWon) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#ffd700';
                ctx.font = '8px monospace';
                ctx.textAlign = 'center';
                ctx.fillText('WIN!', 32, 30);
                ctx.font = '4px monospace';
                ctx.fillText(`Moves: ${moves}`, 32, 36);
                ctx.fillText('Press N', 32, 42);
            }
        }

        function isBlocked(x, y, excludeBlock = null) {
            if (x < 0 || x >= 64 || y < 0 || y >= 64) return true;
            if (walls.some(w => w.x === x && w.y === y)) return true;
            if (pushBlocks.some(b => b !== excludeBlock && b.x === x && b.y === y)) return true;
            return false;
        }

        function processSpecialTiles(block) {
            let processed = true;
            let iterations = 0;
            
            while (processed && iterations < 100) { // Prevent infinite loops
                processed = false;
                iterations++;
                
                // Check for spring
                if (springs.some(s => s.x === block.x && s.y === block.y)) {
                    // Launch upward
                    let launchY = block.y - 1;
                    while (launchY >= 0 && !isBlocked(block.x, launchY, block)) {
                        launchY--;
                    }
                    if (launchY < block.y - 1) {
                        block.y = launchY + 1;
                        processed = true;
                    }
                }
                
                // Check for teleporter input
                const tpIndex = teleportersIn.findIndex(t => t.x === block.x && t.y === block.y);
                if (tpIndex !== -1 && tpIndex < teleportersOut.length) {
                    const output = teleportersOut[tpIndex];
                    if (!isBlocked(output.x, output.y, block)) {
                        block.x = output.x;
                        block.y = output.y;
                        processed = true;
                    }
                }
            }
        }

        function moveBlock(block, dx, dy) {
            let newX = block.x + dx;
            let newY = block.y + dy;
            
            // Check if movement is blocked
            if (isBlocked(newX, newY, block)) {
                return false;
            }
            
            // Check if on ice - continue sliding
            if (ice.some(i => i.x === block.x && i.y === block.y)) {
                while (!isBlocked(newX, newY, block) && ice.some(i => i.x === newX && i.y === newY)) {
                    block.x = newX;
                    block.y = newY;
                    newX += dx;
                    newY += dy;
                }
                if (!isBlocked(newX, newY, block)) {
                    block.x = newX;
                    block.y = newY;
                }
            } else {
                block.x = newX;
                block.y = newY;
            }
            
            // Process special tiles (springs and teleporters)
            processSpecialTiles(block);
            
            return true;
        }

        function movePlayer(dx, dy) {
            if (gameWon) return;
            
            const newX = player.x + dx;
            const newY = player.y + dy;
            
            if (newX < 0 || newX >= 64 || newY < 0 || newY >= 64) return;
            if (walls.some(w => w.x === newX && w.y === newY)) return;
            
            const block = pushBlocks.find(b => b.x === newX && b.y === newY);
            if (block) {
                if (!moveBlock(block, dx, dy)) return;
            }
            
            player.x = newX;
            player.y = newY;
            moves++;
            
            // Check for player on spring
            if (springs.some(s => s.x === player.x && s.y === player.y)) {
                let launchY = player.y - 1;
                while (launchY >= 0 && !walls.some(w => w.x === player.x && w.y === launchY) &&
                       !pushBlocks.some(b => b.x === player.x && b.y === launchY)) {
                    launchY--;
                }
                player.y = launchY + 1;
            }
            
            // Check for player on teleporter input
            const tpIndex = teleportersIn.findIndex(t => t.x === player.x && t.y === player.y);
            if (tpIndex !== -1 && tpIndex < teleportersOut.length) {
                const output = teleportersOut[tpIndex];
                if (!walls.some(w => w.x === output.x && w.y === output.y) &&
                    !pushBlocks.some(b => b.x === output.x && b.y === output.y)) {
                    player.x = output.x;
                    player.y = output.y;
                }
            }
            
            updateDisplay();
            
            if (pushBlocks.every(b => goals.some(g => g.x === b.x && g.y === b.y))) {
                gameWon = true;
                if (!bestScores[currentLevel - 1] || moves < bestScores[currentLevel - 1]) {
                    bestScores[currentLevel - 1] = moves;
                }
            }
            
            draw();
        }

        function updateDisplay() {
            document.getElementById('moves').textContent = moves;
            document.getElementById('level').textContent = currentLevel;
            document.getElementById('best').textContent = bestScores[currentLevel - 1] || '--';
        }

        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'ArrowUp': e.preventDefault(); movePlayer(0, -1); break;
                case 'ArrowDown': e.preventDefault(); movePlayer(0, 1); break;
                case 'ArrowLeft': e.preventDefault(); movePlayer(-1, 0); break;
                case 'ArrowRight': e.preventDefault(); movePlayer(1, 0); break;
                case 'r': case 'R': loadLevel(currentLevel); break;
                case 'n': case 'N': if (gameWon) loadLevel(currentLevel + 1); break;
            }
        });

        loadLevel(4);
    </script>
</body>
</html>